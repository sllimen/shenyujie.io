<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="stay hungry stay foolish"><title>fis3脚本以及基于nodejs的ftp上传工具 | 愿无岁月可回首</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.1"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">fis3脚本以及基于nodejs的ftp上传工具</h1><a id="logo" href="/.">愿无岁月可回首</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">fis3脚本以及基于nodejs的ftp上传工具</h1><div class="post-meta">Feb 16, 2016<span> | </span><span class="category"><a href="/categories/javascript/">javascript</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><div class="post-content"><p>前言：fis3 可以进行文件压缩，灰度发布，自动生成精灵图，最重要的他可以用文件指纹的方式解决浏览器缓存机制所带来的静态资源发布时，用户可能读取的仍是缓存的旧文件而无法实时更新的问题。<a id="more"></a><br><a href="http://fis.baidu.com/fis3/api/index.html" target="_blank" rel="external">具体使用</a><br>例子：（fis3 部分）  </p>
<figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">fis.<span class="keyword">match</span>(<span class="string">'::packager'</span>, &#123;</div><div class="line">  spriter: fis.plugin(<span class="string">'csssprites'</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.<span class="keyword">match</span>(<span class="string">'*'</span>, &#123;</div><div class="line">  useHash: <span class="literal">true</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.<span class="keyword">match</span>(<span class="string">'*.js'</span>, &#123;</div><div class="line">  optimizer: fis.plugin(<span class="string">'uglify-js'</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.<span class="keyword">match</span>(<span class="string">'*.css'</span>, &#123;</div><div class="line">  useSprite: <span class="literal">true</span>,</div><div class="line">  optimizer: fis.plugin(<span class="string">'clean-css'</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.<span class="keyword">match</span>(<span class="string">'*.png'</span>, &#123;</div><div class="line">  optimizer: fis.plugin(<span class="string">'png-compressor'</span>)</div><div class="line">&#125;);</div><div class="line"></div><div class="line">fis.<span class="keyword">match</span>(<span class="string">'*.&#123;png,js,css&#125;'</span>, &#123;</div><div class="line">  release: <span class="string">'/static/$0'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>奈何笔者的项目使用的是 freemaker 的 FTL 作为的模板引擎，fis3 恰好不兼容 FTL 文件的格式，使得 FTL 文件内的静态资源无法使用加入文件指纹后的新文件名造成失效，故而使用 nodejs 写一个脚本，一来生成映射表，映射静态资源加入指纹前后文件名的对应关系，而来批量替换 FTL 文件中相应的静态资源项  </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 由于 fis3 的文件指纹功能不支持 FTL 格式, 故而手动对 FTL 中的文件进行替换</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</div><div class="line"></div><div class="line"><span class="comment">// 储存文件的对应关系</span></div><div class="line"><span class="keyword">var</span> map = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 获取当前进程的工作目录</span></div><div class="line"><span class="keyword">var</span> cwd = process.cwd();</div><div class="line"></div><div class="line"><span class="comment">// 静态资源的释放目录,释放到 rs 目录</span></div><div class="line"><span class="keyword">var</span> staticPath = cwd + <span class="string">'/static'</span>;</div><div class="line"></div><div class="line"><span class="comment">// FTL 模板的存放位置</span></div><div class="line"><span class="keyword">var</span> viewPath = cwd + <span class="string">'/WEB-INF/template'</span>;</div><div class="line"></div><div class="line"><span class="comment">// CSS 文件存放的位置</span></div><div class="line"><span class="keyword">var</span> cssPath = staticPath + <span class="string">'/style'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 对文件以及文件目录进行扫描</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">walk</span>(<span class="params">path, fileCallback, dirCallback</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> dirList = fs.readdirSync(path);</div><div class="line">    dirList.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">item</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> item_path = path + <span class="string">'/'</span> + item;</div><div class="line">        <span class="keyword">if</span> (fs.statSync(item_path).isDirectory()) &#123;</div><div class="line">            dirCallback &amp;&amp; dirCallback(item_path);</div><div class="line">            walk(item_path, fileCallback, dirCallback);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            fileCallback &amp;&amp; fileCallback(item_path);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">"步骤 1: 生成 fis3 转换后前后文件名的对应关系 !"</span>);</div><div class="line"></div><div class="line">walk(staticPath, <span class="function"><span class="keyword">function</span> (<span class="params">item_path</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (item_path.match(<span class="regexp">/_\w&#123;8&#125;\./</span>)) &#123;</div><div class="line">        <span class="comment">// 获取当前文件的相对路径</span></div><div class="line">        <span class="keyword">var</span> relativePath = item_path.replace(staticPath, <span class="string">''</span>);</div><div class="line">        <span class="keyword">var</span> originalPath = relativePath.replace(<span class="regexp">/_\w&#123;8&#125;(?=\.)/</span>, <span class="string">''</span>);</div><div class="line">        map[originalPath] = relativePath;</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">"步骤 2: 处理 FTL 文件"</span>);</div><div class="line"></div><div class="line">walk(viewPath, <span class="function"><span class="keyword">function</span> (<span class="params">item_path</span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">var</span> context = fs.readFileSync(item_path, <span class="string">'utf-8'</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="string">'open '</span> + item_path + <span class="string">' error !'</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> reg = <span class="regexp">/\$&#123;rsRoots\.rsRoot&#125;.*?\.(js|css|jpg|png|ico|gif).*?"/g</span>;</div><div class="line">    context = context.replace(reg, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">        <span class="keyword">var</span> pathReg = <span class="regexp">/\/.*?\.(jpg|png|gif|ico|js|css)\b/g</span>;</div><div class="line">        data = data.replace(pathReg, <span class="function"><span class="keyword">function</span> (<span class="params">match</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> map[match] ? map[match] : match;</div><div class="line">        &#125;);</div><div class="line">        <span class="keyword">return</span> data;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        fs.writeFileSync(item_path, context);</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="string">'write to '</span> + item_path + <span class="string">' error !'</span>);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">"步骤 3: 处理 CSS 文件"</span>);</div><div class="line"></div><div class="line">walk(cssPath, <span class="function"><span class="keyword">function</span> (<span class="params">item_path</span>) </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="keyword">var</span> context = fs.readFileSync(item_path, <span class="string">'utf-8'</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="string">'open '</span> + item_path + <span class="string">' error !'</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> urlReg = <span class="regexp">/url\((http||\.\.)?.*?\)/g</span>,</div><div class="line">        md5Reg = <span class="regexp">/_\w&#123;8&#125;(?=\.)/</span>;</div><div class="line">    context = context.replace(urlReg, <span class="function"><span class="keyword">function</span> (<span class="params">match, isHttpUrl</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isHttpUrl) &#123;</div><div class="line">            <span class="keyword">var</span> pathReg = <span class="regexp">/\/.*\.(png|jpg|ico|gif)/</span>;</div><div class="line">            match = match.replace(pathReg, <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</div><div class="line">                <span class="keyword">return</span> <span class="string">'/rs'</span> + data;</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> match;</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        fs.writeFileSync(item_path, context);</div><div class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</div><div class="line">        <span class="built_in">console</span>.error(<span class="string">'write to '</span> + item_path + <span class="string">' error !'</span>)</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(<span class="string">"释放完毕"</span>);</div></pre></td></tr></table></figure>
<p>编写 nodejs 版本的 FTP 上传工具，以增量的方式上传加入文件指纹后的静态资源至 FTP  </p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 统计失败重试的次数</span></div><div class="line"><span class="keyword">var</span> retryCount = <span class="number">-1</span>;</div><div class="line"></div><div class="line"><span class="comment">// 生成分割线</span></div><div class="line"><span class="keyword">var</span> couLine = repeat(<span class="string">'-'</span>, <span class="number">25</span>);</div><div class="line"></div><div class="line">process.on(<span class="string">'uncaughtException'</span>, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>&#123;</div><div class="line">    <span class="comment">// 最多尝试 5 次</span></div><div class="line">    <span class="keyword">if</span> (retryCount &lt;= <span class="number">5</span>) doFtpWork();</div><div class="line">    <span class="keyword">else</span> process.<span class="keyword">exit</span>();</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// 自动提交经过 fis3 转换过的静态资源到服务器</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> path = <span class="keyword">require</span>(<span class="string">'path'</span>);</div><div class="line"><span class="keyword">var</span> fs = <span class="keyword">require</span>(<span class="string">'fs'</span>);</div><div class="line"><span class="keyword">var</span> client = <span class="keyword">require</span>(<span class="string">'ftp'</span>);</div><div class="line"></div><div class="line"><span class="comment">// 用于储存需要创建的文件夹</span></div><div class="line"><span class="keyword">var</span> folderStore = [];</div><div class="line"></div><div class="line"><span class="comment">// 用于储存需要上传的文件</span></div><div class="line"><span class="keyword">var</span> fileStore = [];</div><div class="line"></div><div class="line"><span class="comment">// 用于标记本地文件的上传类型</span></div><div class="line"><span class="keyword">var</span> upMap = [];</div><div class="line"></div><div class="line"><span class="comment">// 获取当前进程的工作目录</span></div><div class="line"><span class="keyword">var</span> cwd = process.cwd();</div><div class="line"></div><div class="line"><span class="comment">// 静态资源的释放目录,释放到 rs 目录</span></div><div class="line"><span class="keyword">var</span> staticPath = cwd + <span class="string">'/static'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 需要上传到的 ftp 服务器的目录</span></div><div class="line"><span class="keyword">var</span> file_directory = <span class="string">'p2b/nodejsFTP/static'</span>;</div><div class="line"></div><div class="line"><span class="comment">// 用户名和密码信息</span></div><div class="line"><span class="keyword">var</span> ftpConfig = &#123;</div><div class="line">    host: <span class="string">"192.168.60.228"</span>,</div><div class="line">    user: <span class="string">"dev"</span>,</div><div class="line">    password: <span class="string">"cc.123"</span></div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 功能:用于生成重复字符串</div><div class="line"> * <span class="doctag">@param</span> target</div><div class="line"> * <span class="doctag">@param</span> n</div><div class="line"> * <span class="doctag">@returns</span> &#123;string&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">repeat</span><span class="params">(target, n)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> (<span class="keyword">new</span> <span class="keyword">Array</span>(n + <span class="number">1</span>)).join(target);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 功能 : 遍历本地的文件及其目录</div><div class="line"> * <span class="doctag">@param</span> path</div><div class="line"> * <span class="doctag">@param</span> fileCallback</div><div class="line"> * <span class="doctag">@param</span> dirCallback</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">walk</span><span class="params">(path, fileCallback, dirCallback)</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> dirList = fs.readdirSync(path);</div><div class="line">    dirList.<span class="keyword">forEach</span>(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> </span>&#123;</div><div class="line">        <span class="keyword">var</span> item_path = path + <span class="string">'/'</span> + item;</div><div class="line">        <span class="keyword">if</span> (fs.statSync(item_path).isDirectory()) &#123;</div><div class="line">            dirCallback &amp;&amp; dirCallback(item_path);</div><div class="line">            walk(item_path, fileCallback, dirCallback);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            fileCallback &amp;&amp; fileCallback(item_path);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 功能 : 遍历固定目录下所有的文件</div><div class="line"> * <span class="doctag">@param</span> directory</div><div class="line"> * <span class="doctag">@param</span> fileCallback</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">walk_ftp</span><span class="params">(directory, fileCallback)</span> </span>&#123;</div><div class="line">    <span class="comment">// 新建本地的 FTP 服务</span></div><div class="line">    <span class="keyword">var</span> ftp = <span class="keyword">new</span> client();</div><div class="line">    <span class="comment">// 连接 ftp 服务器</span></div><div class="line">    ftp.connect(ftpConfig);</div><div class="line">    <span class="comment">// 获取 ftp 指定目录下所有的文件</span></div><div class="line">    ftp.on(<span class="string">'ready'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        ftp.cwd(directory, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">            ftp.<span class="keyword">list</span>(<span class="function"><span class="keyword">function</span> <span class="params">(err, list)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">                <span class="keyword">list</span>.<span class="keyword">forEach</span>(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> </span>&#123;</div><div class="line">                    <span class="keyword">var</span> next = path.join(directory, item.name);</div><div class="line">                    <span class="comment">// 如果是目录</span></div><div class="line">                    <span class="keyword">if</span> (item.type &amp;&amp; item.type.trim() == <span class="string">'d'</span>) &#123;</div><div class="line">                        walk_ftp(next, fileCallback);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        fileCallback &amp;&amp; fileCallback(next);</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">                ftp.end();</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> *  * * 判断文件写入服务器的方式:</div><div class="line"> *      1. 直接写入</div><div class="line"> *      2. 删除 ftp 上的旧文件后写入</div><div class="line"> *      3. 无需写入,跳过</div><div class="line"> * 可以写入的条件是:</div><div class="line"> *      1. 此文件没有出现在指定目录中,直接写入</div><div class="line"> *      2. FTP 上存在旧的文件,删除后写入</div><div class="line"> *      3. 文件未发生改变,无需写入</div><div class="line"> * <span class="doctag">@param</span> folder</div><div class="line"> * <span class="doctag">@param</span> file</div><div class="line"> * <span class="doctag">@param</span> succ</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeToFtp</span><span class="params">(folder, file, succ)</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> upload = <span class="keyword">new</span> client();</div><div class="line">    upload.connect(ftpConfig);</div><div class="line">    upload.on(<span class="string">'ready'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        upload.cwd(toFtpPath(folder), <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">            upload.<span class="keyword">list</span>(<span class="function"><span class="keyword">function</span> <span class="params">(err, list)</span> </span>&#123;</div><div class="line">                <span class="keyword">var</span> file_arr = [];</div><div class="line">                <span class="keyword">list</span>.<span class="keyword">forEach</span>(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (!(item.type &amp;&amp; item.type == <span class="string">'d'</span>)) &#123;</div><div class="line">                        <span class="keyword">var</span> name = item.name || <span class="string">''</span>;</div><div class="line">                        <span class="keyword">if</span> (file_arr.indexOf(name) == <span class="number">-1</span>) &#123;</div><div class="line">                            file_arr.push(name);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;);</div><div class="line">                (<span class="function"><span class="keyword">function</span> <span class="title">inner</span><span class="params">(upload, ftp_arr)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (file.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                        <span class="comment">// ftp上的文件名</span></div><div class="line">                        <span class="keyword">var</span> ori_ftp = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">var</span> reg = /_\w&#123;<span class="number">8</span>&#125;(?=\.)/;</div><div class="line">                        <span class="comment">// 写入类型</span></div><div class="line">                        <span class="keyword">var</span> type = <span class="number">1</span>;</div><div class="line">                        <span class="comment">// 获取当前文件</span></div><div class="line">                        <span class="keyword">var</span> curFile = file.shift();</div><div class="line">                        <span class="comment">// 获取当前文件对应的 FTP 地址</span></div><div class="line">                        <span class="keyword">var</span> ftp_path = toFtpPath(curFile);</div><div class="line">                        <span class="comment">// 获取当前文件的文件名</span></div><div class="line">                        <span class="keyword">var</span> file_name = path.basename(ftp_path);</div><div class="line">                        <span class="comment">// 获取当前文件 fis3 转换前的文件名</span></div><div class="line">                        <span class="keyword">var</span> ori_file_name = file_name.replace(reg, <span class="string">''</span>);</div><div class="line">                        ftp_arr.<span class="keyword">forEach</span>(<span class="function"><span class="keyword">function</span> <span class="params">(ftp_name)</span> </span>&#123;</div><div class="line">                            <span class="comment">// 获取 fis3 处理前的 ftp 文件名</span></div><div class="line">                            <span class="keyword">var</span> ori_ftp_name = ftp_name.replace(reg, <span class="string">''</span>);</div><div class="line">                            <span class="comment">// 判断写入方式</span></div><div class="line">                            <span class="keyword">if</span> (ftp_name == file_name) &#123;</div><div class="line">                                <span class="comment">// 文件未发生改变,无需写入</span></div><div class="line">                                type = <span class="number">3</span>;</div><div class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ori_ftp_name == ori_file_name) &#123;</div><div class="line">                                <span class="comment">// 存在旧文件</span></div><div class="line">                                type = <span class="number">2</span>;</div><div class="line">                                <span class="keyword">var</span> parentFtp = path.dirname(ftp_path);</div><div class="line">                                ori_ftp = path.join(parentFtp, ftp_name);</div><div class="line">                            &#125;</div><div class="line">                        &#125;);</div><div class="line">                        <span class="keyword">var</span> map = &#123;&#125;;</div><div class="line">                        map.type = type;</div><div class="line">                        map.file = curFile;</div><div class="line">                        map.ori_ftp = ori_ftp;</div><div class="line">                        map.fileToFtp = ftp_path;</div><div class="line">                        upMap.push(map);</div><div class="line">                        inner(upload, ftp_arr);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        succ &amp;&amp; succ(upMap);</div><div class="line">                        upload.end();</div><div class="line">                    &#125;</div><div class="line">                &#125;)(upload, file_arr);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 功能 : 把本地文件的路径转换成 ftp 的路径</div><div class="line"> * <span class="doctag">@param</span> item_path</div><div class="line"> * <span class="doctag">@returns</span> &#123;*&#125;</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">toFtpPath</span><span class="params">(item_path)</span> </span>&#123;</div><div class="line">    <span class="comment">// 获取文件的相对路径</span></div><div class="line">    <span class="keyword">var</span> relative = item_path.replace(staticPath, <span class="string">''</span>);</div><div class="line">    <span class="comment">// 返回 FTP 上的文件地址</span></div><div class="line">    <span class="keyword">return</span> path.join(file_directory, relative);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 在 FTP 上创建文件夹</div><div class="line"> * <span class="doctag">@param</span> succ</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">createFtpFolder</span><span class="params">(succ)</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> upload = <span class="keyword">new</span> client();</div><div class="line">    upload.connect(ftpConfig);</div><div class="line">    upload.on(<span class="string">'ready'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        (<span class="function"><span class="keyword">function</span> <span class="title">inner</span><span class="params">(upload, finish)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (folderStore.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">var</span> ftp_path = folderStore.shift();</div><div class="line">                upload.mkdir(ftp_path, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>&#123;</div><div class="line">                    <span class="keyword">if</span> (err) console.log(<span class="string">"文件夹 : "</span> + ftp_path.replace(file_directory, <span class="string">''</span>) + <span class="string">" 存在 !"</span>);</div><div class="line">                    <span class="keyword">else</span> console.log(<span class="string">"文件夹 : "</span> + ftp_path.replace(file_directory, <span class="string">''</span>) + <span class="string">" 创建成功 !"</span>);</div><div class="line">                    inner(upload, finish);</div><div class="line">                &#125;);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                finish &amp;&amp; finish();</div><div class="line">                upload.end();</div><div class="line">            &#125;</div><div class="line">        &#125;)(upload, succ);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 对需要上传的文件按照所在的目录排序</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">classifyByFolder</span><span class="params">(fileStore)</span> </span>&#123;</div><div class="line">    <span class="comment">// 用于存储目录与目录下的文件的对应关系</span></div><div class="line">    <span class="keyword">var</span> map = &#123;&#125;;</div><div class="line">    <span class="keyword">var</span> length = <span class="number">0</span>;</div><div class="line">    fileStore.<span class="keyword">forEach</span>(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> </span>&#123;</div><div class="line">        <span class="comment">// 获取文件的目录</span></div><div class="line">        <span class="keyword">var</span> dir = path.dirname(item);</div><div class="line">        <span class="keyword">if</span> (!map[dir]) &#123;</div><div class="line">            map[dir] = [];</div><div class="line">            ++length;</div><div class="line">        &#125;</div><div class="line">        map[dir].push(item);</div><div class="line">    &#125;);</div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        map: map,</div><div class="line">        length: length</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 功能 : ftp 发送文件</div><div class="line"> * <span class="doctag">@param</span> upload</div><div class="line"> * <span class="doctag">@param</span> diskPath</div><div class="line"> * <span class="doctag">@param</span> ftpPath</div><div class="line"> * <span class="doctag">@param</span> succ</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">fileToFtp</span><span class="params">(upload, diskPath, ftpPath, succ)</span> </span>&#123;</div><div class="line">    upload.put(diskPath, ftpPath, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">        succ &amp;&amp; succ();</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * 功能 : 删除 FTP 的指定文件</div><div class="line"> * <span class="doctag">@param</span> delDown</div><div class="line"> * <span class="doctag">@param</span> ftpPath</div><div class="line"> * <span class="doctag">@param</span> succ</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">deleteFromFtp</span><span class="params">(delDown, ftpPath, succ)</span> </span>&#123;</div><div class="line">    delDown.delete(ftpPath, <span class="function"><span class="keyword">function</span> <span class="params">(err)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (err) <span class="keyword">throw</span> err;</div><div class="line">        succ &amp;&amp; succ();</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 上传文件去 ftp</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">sendToFtp</span><span class="params">(upMap, succ)</span> </span>&#123;</div><div class="line">    <span class="keyword">var</span> upload = <span class="keyword">new</span> client();</div><div class="line">    upload.connect(ftpConfig);</div><div class="line">    upload.on(<span class="string">'ready'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">        (<span class="function"><span class="keyword">function</span> <span class="title">inner</span><span class="params">(upload, finish)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (upMap.length &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">var</span> curMap = upMap.shift();</div><div class="line">                <span class="keyword">if</span> (curMap.type == <span class="number">3</span>) &#123;</div><div class="line">                    console.log(<span class="string">"文件: "</span> + path.basename(curMap.file) + <span class="string">"未发生改变,无需上传!"</span>);</div><div class="line">                    inner(upload, finish);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// 直接写入</span></div><div class="line">                    <span class="keyword">if</span> (curMap.type == <span class="number">1</span>) &#123;</div><div class="line">                        fileToFtp(upload, curMap.file, curMap.fileToFtp, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">                            console.log(<span class="string">"新增文件: "</span> + path.basename(curMap.fileToFtp) + <span class="string">"成功!"</span>);</div><div class="line">                            inner(upload, finish);</div><div class="line">                        &#125;);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="comment">// 删除后写入</span></div><div class="line">                        curMap.ori_ftp &amp;&amp; deleteFromFtp(upload, curMap.ori_ftp, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">                            console.log(<span class="string">"删除旧文件: "</span> + path.basename(curMap.ori_ftp) + <span class="string">"成功!"</span>);</div><div class="line">                            fileToFtp(upload, curMap.file, curMap.fileToFtp, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">                                console.log(<span class="string">"更新文件: "</span> + path.basename(curMap.fileToFtp) + <span class="string">"成功!"</span>);</div><div class="line">                                inner(upload, finish);</div><div class="line">                            &#125;);</div><div class="line">                        &#125;);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                succ &amp;&amp; succ();</div><div class="line">                upload.end();</div><div class="line">            &#125;</div><div class="line">        &#125;)(upload, succ);</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">doFtpWork</span><span class="params">()</span> </span>&#123;</div><div class="line">    ++retryCount;</div><div class="line">    <span class="comment">//打印出错误</span></div><div class="line">    console.log(<span class="string">'步骤4 : 获取需要创建的文件夹'</span>);</div><div class="line">    <span class="comment">// 获取需要上传文件的所有路径,以供在需要时创建</span></div><div class="line">    walk(staticPath, <span class="function"><span class="keyword">function</span> <span class="params">(item_path)</span> </span>&#123;</div><div class="line">        <span class="comment">// 获取需要上传的文件</span></div><div class="line">        fileStore.push(item_path);</div><div class="line">        <span class="comment">// 获取 FTP 上的文件地址</span></div><div class="line">        <span class="keyword">var</span> ftpPath = toFtpPath(item_path);</div><div class="line">        <span class="comment">// 获取文件所在的文件夹</span></div><div class="line">        <span class="keyword">var</span> folder = path.dirname(ftpPath);</div><div class="line">        <span class="comment">// 对路径进行格式化操作</span></div><div class="line">        <span class="keyword">var</span> n_ftpPath = path.normalize(folder);</div><div class="line">        <span class="keyword">var</span> n_file_directory = path.normalize(file_directory);</div><div class="line">        <span class="comment">// 获取相对路径</span></div><div class="line">        <span class="keyword">var</span> relative = n_ftpPath.replace(n_file_directory, <span class="string">''</span>);</div><div class="line">        <span class="comment">// 获取所有的分路径数组</span></div><div class="line">        relative = relative.split(path.sep).filter(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> </span>&#123;</div><div class="line">            <span class="comment">// 去掉数组中空字符串的元素</span></div><div class="line">            <span class="keyword">return</span> item;</div><div class="line">        &#125;);</div><div class="line">        <span class="comment">// 获取所有的分路径,并去重</span></div><div class="line">        <span class="keyword">if</span> (relative.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= relative.length; i++) &#123;</div><div class="line">                <span class="comment">// 获取所有的分路径数组</span></div><div class="line">                <span class="keyword">var</span> path_array = relative.slice(<span class="number">0</span>, i);</div><div class="line">                <span class="comment">// 获取分路径</span></div><div class="line">                <span class="keyword">var</span> single_path = path.normalize(file_directory);</div><div class="line">                path_array.<span class="keyword">forEach</span>(<span class="function"><span class="keyword">function</span> <span class="params">(item)</span> </span>&#123;</div><div class="line">                    single_path = path.join(single_path, item)</div><div class="line">                &#125;);</div><div class="line">                <span class="keyword">if</span> (folderStore.indexOf(single_path) == <span class="number">-1</span>) &#123;</div><div class="line">                    folderStore.push(single_path);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// 创建文件夹</span></div><div class="line">    <span class="keyword">if</span> (folderStore.length &gt; <span class="number">0</span>) &#123;</div><div class="line">        createFtpFolder(<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">            console.log(<span class="string">'步骤5 : 文件夹创建完毕,开始上传文件'</span>);</div><div class="line">            <span class="comment">// 把文件按照所在的目录归类</span></div><div class="line">            <span class="keyword">var</span> classify = classifyByFolder(fileStore);</div><div class="line">            <span class="keyword">var</span> map = classify.map;</div><div class="line">            <span class="comment">// 获取 map 的 length</span></div><div class="line">            <span class="keyword">var</span> length = classify.length;</div><div class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> folder in map) &#123;</div><div class="line">                <span class="keyword">if</span> (map.hasOwnProperty(folder)) &#123;</div><div class="line">                    mergeToFtp(folder, map[folder], <span class="function"><span class="keyword">function</span> <span class="params">(upMap)</span> </span>&#123;</div><div class="line">                        <span class="keyword">if</span> (--length == <span class="number">0</span>) &#123;</div><div class="line">                            <span class="comment">// 遍历完所有的文件之后,根据上传类型上传文件</span></div><div class="line">                            sendToFtp(upMap, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</div><div class="line">                                console.log(couLine + <span class="string">"上传完成"</span> + couLine);</div><div class="line">                            &#125;);</div><div class="line">                        &#125;</div><div class="line">                    &#125;);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">doFtpWork();</div></pre></td></tr></table></figure>
</div><script type="text/javascript" src="/js/share.js?v=0.0.1" async></script><a data-url="http://yoursite.com/2016/02/16/fis3脚本以及基于nodejs的ftp上传工具/" data-id="cj21m0wiu0010k8shqvpfs37o" class="article-share-link">分享到</a><div class="tags"><a href="/tags/fis3/">fis3</a></div><div class="post-nav"><a href="/2016/04/05/清明/" class="pre">清明寒食</a></div></div></div></div><div class="pure-u-1-4"><div id="sidebar"><div class="widget"><form action="//www.baidu.com/baidu" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="search" name="word" maxlength="20" placeholder="Search"/><input type="hidden" name="si" value="http://yoursite.com"/><input name="tn" type="hidden" value="bds"/><input name="cl" type="hidden" value="3"/><input name="ct" type="hidden" value="2097152"/><input name="s" type="hidden" value="on"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/ES6/">ES6</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/canvas/">canvas</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css-布局/">css 布局</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/html/">html</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/javascript/">javascript</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><span class="category-list-count">2</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/css/" style="font-size: 15px;">css</a> <a href="/tags/跨域/" style="font-size: 15px;">跨域</a> <a href="/tags/移动端/" style="font-size: 15px;">移动端</a> <a href="/tags/fis3/" style="font-size: 15px;">fis3</a> <a href="/tags/javascript/" style="font-size: 15px;">javascript</a> <a href="/tags/箭头函数/" style="font-size: 15px;">箭头函数</a> <a href="/tags/ES6/" style="font-size: 15px;">ES6</a> <a href="/tags/心情/" style="font-size: 15px;">心情</a> <a href="/tags/html/" style="font-size: 15px;">html</a> <a href="/tags/canvas-retina-兼容性/" style="font-size: 15px;">canvas retina 兼容性</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2017/04/28/关于-ES6-中的箭头函数（一）/">关于 ES6 中的箭头函数</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/03/08/简单尝试下-JS-中点击（单击）事件的触发顺序/">简单尝试下 JS 中点击（单击）事件的触发顺序</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/22/CSS-实现元素垂直居中/">CSS 实现元素垂直居中</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/17/解决-HTML5-Canvas-在高分屏下的模糊问题/">解决 HTML5 Canvas 在高分屏下的模糊问题</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/02/09/CSS-改变选中时改变选中文字的颜色及背景色/">CSS 改变选中时改变选中文字的颜色及背景色</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/22/Javascript-跨域-七-之-postMessage/">Javascript 跨域(七) 之 postMessage</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/21/Javascript跨域-六-之-document-domain-iframe/">Javascript 跨域(六)之 document.domain + iframe</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/15/Javascript-跨-五-之-window-location-hash-iframe/">Javascript 跨域(五)之 window.location.hash + iframe</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/10/Javascipt-跨域-四-之-window-name-iframe/">Javascript 跨域(四)之 window.name + iframe</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/08/01/Javascript-跨域之-WebSocket/">Javascript 跨域(三)之 WebSocket</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.baidu.com/" title="百度" target="_blank">百度</a><ul></ul><a href="http://deerchao.net/tutorials/regex/regex.htm#mission" title="正则表达式教程" target="_blank">正则表达式教程</a><ul></ul><a href="http://www.duzhe.com/" title="读者" target="_blank">读者</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">愿无岁月可回首.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.1" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.1" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.1"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.1"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.1"></script></div></body></html>